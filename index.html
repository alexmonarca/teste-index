<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conectar WhatsApp - Monarca Hub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            width: 100%;
        }
        .card { 
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 15px;
        }
        .steps {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            text-align: left;
        }
        .steps h3 {
            color: #25D366;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 12px;
        }
        .step-number {
            background: #25D366;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .step-text {
            flex: 1;
            color: #555;
            line-height: 1.6;
            padding-top: 3px;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }
        .btn-secondary {
            background: white;
            color: #25D366;
            border: 2px solid #25D366;
        }
        .btn-secondary:hover {
            background: #f0fdf4;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #status { 
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            min-height: 50px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .status-visible { display: flex !important; }
        .status-loading {
            background: #fff3e0;
            color: #f57c00;
        }
        .status-success {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
        }
        .info-box strong {
            color: #1976d2;
            display: block;
            margin-bottom: 8px;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .method-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }
        .method-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .method-card:hover {
            border-color: #25D366;
            background: #f0fdf4;
        }
        .method-card.active {
            border-color: #25D366;
            background: #e8f5e9;
        }
        .method-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .method-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .method-desc {
            font-size: 12px;
            color: #666;
        }
        @media (max-width: 600px) {
            .method-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <div class="logo">üì±</div>
            <h1>Conectar WhatsApp Business</h1>
            <p class="subtitle">Monarca Hub - Modo Coexist√™ncia</p>

            <div class="steps">
                <h3>‚ú® O que voc√™ vai conseguir:</h3>
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-text">Continuar usando WhatsApp Business no celular normalmente</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-text">Agente de IA responde automaticamente via API</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-text">Equipe pode intervir quando necess√°rio pelo app</div>
                </div>
            </div>

            <div class="info-box">
                <strong>üí° Escolha o m√©todo de conex√£o:</strong>
                Recomendamos o <strong>M√©todo Autom√°tico</strong> para uma experi√™ncia mais r√°pida e sem complica√ß√µes.
            </div>

            <div class="method-selector">
                <div class="method-card active" onclick="selectMethod('auto')" id="method-auto">
                    <div class="method-icon">üöÄ</div>
                    <div class="method-title">Autom√°tico</div>
                    <div class="method-desc">Conex√£o em 1 clique<br>(Recomendado)</div>
                </div>
                <div class="method-card" onclick="selectMethod('manual')" id="method-manual">
                    <div class="method-icon">‚öôÔ∏è</div>
                    <div class="method-title">Guiado</div>
                    <div class="method-desc">Passo a passo<br>pela Meta</div>
                </div>
            </div>

            <div class="button-group" id="auto-method">
                <button class="btn btn-primary" id="connectBtn" onclick="launchWhatsAppSignup()">
                    üîó Conectar Automaticamente
                </button>
                <small style="color: #999;">Um popup ser√° aberto para voc√™ fazer login na Meta</small>
            </div>

            <div class="button-group" id="manual-method" style="display: none;">
                <a href="https://business.facebook.com/messaging/whatsapp/onboard/?app_id=1322580525486349&config_id=878421224769472&extras=%7B%22featureType%22%3A%22whatsapp_business_app_onboarding%22%2C%22sessionInfoVersion%22%3A%223%22%2C%22version%22%3A%22v3%22%2C%22features%22%3A[%7B%22name%22%3A%22app_only_install%22%7D]%7D" 
                   class="btn btn-primary" 
                   target="_blank"
                   onclick="trackManualClick()">
                    üìã Abrir Assistente da Meta
                </a>
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; font-size: 13px; text-align: left;">
                    ‚ö†Ô∏è <strong>Importante:</strong> Ap√≥s concluir no site da Meta, entre em contato conosco para finalizar a configura√ß√£o.
                </div>
            </div>

            <div id="status"></div>
        </div>
    </div>

    <script>
        const CONFIG = {
            appId: '1322580525486349',
            configId: '878421224769472',
            webhookUrl: 'https://webhook.monarcahub.com/webhook/whatsapp-setup'
        };

        let selectedMethod = 'auto';

        function selectMethod(method) {
            selectedMethod = method;
            
            // Atualiza visual dos cards
            document.getElementById('method-auto').classList.toggle('active', method === 'auto');
            document.getElementById('method-manual').classList.toggle('active', method === 'manual');
            
            // Mostra/esconde bot√µes
            document.getElementById('auto-method').style.display = method === 'auto' ? 'flex' : 'none';
            document.getElementById('manual-method').style.display = method === 'manual' ? 'flex' : 'none';
        }

        function trackManualClick() {
            updateStatus('üìã Siga as instru√ß√µes no site da Meta. Ap√≥s concluir, entre em contato conosco!', 'loading');
            
            // Opcional: Enviar notifica√ß√£o para seu backend
            fetch(CONFIG.webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    event: 'manual_setup_started',
                    timestamp: new Date().toISOString()
                })
            }).catch(() => {});
        }

        window.fbAsyncInit = function() {
            FB.init({
                appId: CONFIG.appId,
                autoLogAppEvents: true,
                xfbml: true,
                version: 'v21.0'
            });
            console.log('‚úÖ SDK Meta inicializado');
        };

        function updateStatus(message, type = 'loading', showSpinner = false) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status-${type} status-visible`;
            statusEl.innerHTML = showSpinner 
                ? `<div class="spinner"></div>${message}`
                : message;
        }

        function launchWhatsAppSignup() {
            updateStatus('Abrindo popup da Meta...', 'loading', true);
            document.getElementById('connectBtn').disabled = true;

            if (typeof FB === 'undefined') {
                updateStatus('‚ùå Erro: SDK n√£o carregou. Recarregue a p√°gina.', 'error');
                document.getElementById('connectBtn').disabled = false;
                return;
            }

            FB.login(function(response) {
                console.log('Resposta FB.login:', response);

                if (response.authResponse) {
                    const accessToken = response.authResponse.accessToken;
                    const code = response.authResponse.code;
                    
                    console.log('‚úÖ Token obtido:', accessToken);
                    
                    updateStatus('‚úÖ Conectado! Finalizando configura√ß√£o...', 'success');

                    // Envia token para seu backend
                    sendToBackend(accessToken, code);

                } else {
                    console.log('‚ùå Conex√£o cancelada');
                    updateStatus('‚ùå Voc√™ cancelou a conex√£o ou ocorreu um erro.', 'error');
                    document.getElementById('connectBtn').disabled = false;
                }
            }, {
                config_id: CONFIG.configId,
                response_type: 'code',
                override_default_response_type: true,
                scope: 'whatsapp_business_management,whatsapp_business_messaging,business_management'
            });
        }

        async function sendToBackend(accessToken, code) {
            try {
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event: 'whatsapp_connected',
                        access_token: accessToken,
                        code: code,
                        timestamp: new Date().toISOString(),
                        user_agent: navigator.userAgent
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Configura√ß√£o enviada com sucesso');
                    updateStatus('‚úÖ Tudo pronto! Seu WhatsApp est√° conectado e o agente de IA logo estar√° ativo. üéâ', 'success');
                    
                    // Desabilita bot√£o permanentemente
                    document.getElementById('connectBtn').textContent = '‚úì Conectado com Sucesso';
                    
                } else {
                    throw new Error('Erro ao enviar configura√ß√£o');
                }
            } catch (error) {
                console.error('‚ùå Erro:', error);
                updateStatus('‚ö†Ô∏è Conex√£o realizada, mas houve um problema ao finalizar. Entre em contato conosco.', 'error');
            }
        }
    </script>

    <script async defer crossorigin="anonymous" 
            src="https://connect.facebook.net/pt_BR/sdk.js">
    </script>

</body>
</html>
